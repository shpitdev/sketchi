name: Diagram API Endpoints
vars:
  target_url: "http://localhost:3001"
  bypass_secret: "local-dev"
  trace_id_generate: "00000000-0000-4000-8000-000000000101"
  trace_id_parse: "00000000-0000-4000-8000-000000000102"
  trace_id_modify: "00000000-0000-4000-8000-000000000103"
  trace_id_share: "00000000-0000-4000-8000-000000000104"
  trace_id_error: "00000000-0000-4000-8000-000000000105"
  encoded_share_prefix: "https%3A%2F%2Fexcalidraw.com%2F%23json%3D"
  encoded_v2_share_url: "https%3A%2F%2Fexcalidraw.com%2F%23json%3Du124S5epdCKEF07WlyRT7%2C_gQTcjl4lABzz__Fcytufg"
  test_intermediate:
    nodes:
      - id: "node-1"
        label: "Start"
      - id: "node-2"
        label: "End"
    edges:
      - fromId: "node-1"
        toId: "node-2"
        label: "next"
    graphOptions:
      diagramType: "flowchart"
  share_elements:
    - id: "node-1"
      type: "rectangle"
      x: 0
      y: 0
      width: 120
      height: 60
      angle: 0
      strokeColor: "#1971c2"
      backgroundColor: "#a5d8ff"
      fillStyle: "solid"
      strokeWidth: 2
      strokeStyle: "solid"
      roughness: 1
      opacity: 100
      groupIds: []
      frameId: null
      index: "a0"
      roundness:
        type: 3
      seed: 101
      version: 1
      versionNonce: 30101
      isDeleted: false
      boundElements: null
      updated: 1725000000000
      link: null
      locked: false

secrets:
  - bypass_secret

testcases:
  - name: generate_parse_flow
    steps:
      - type: http
        method: POST
        url: "{{.target_url}}/api/diagrams/generate"
        headers:
          Content-Type: application/json
          x-vercel-protection-bypass: "{{.bypass_secret}}"
          x-trace-id: "{{.trace_id_generate}}"
        body: |
          {
            "intermediate": {
              "nodes": [
                { "id": "node-1", "label": "Start" },
                { "id": "node-2", "label": "End" }
              ],
              "edges": [
                { "fromId": "node-1", "toId": "node-2", "label": "next" }
              ],
              "graphOptions": { "diagramType": "flowchart" }
            }
          }
        vars:
          share_url:
            from: result.bodyjson.shareLink.url
          share_id:
            from: result.bodyjson.shareLink.shareId
          encryption_key:
            from: result.bodyjson.shareLink.encryptionKey
        assertions:
          - result.statuscode ShouldEqual 200
          - result.headers.X-Trace-Id ShouldEqual "{{.trace_id_generate}}"
          - result.bodyjson.status ShouldEqual "success"
          - result.bodyjson.shareLink.url ShouldContainSubstring "https://excalidraw.com/#json="
          - result.bodyjson.stats.traceId ShouldEqual "{{.trace_id_generate}}"

      - type: exec
        script: |
          set -e
          tmpfile="$(mktemp)"
          curl -fsSL --retry 3 --retry-all-errors -o "$tmpfile" "https://json.excalidraw.com/api/v2/{{.generate_parse_flow.share_id}}"
          od -An -t x1 -N 4 "$tmpfile" | tr -d ' \n'
          rm -f "$tmpfile"
        vars:
          v2_magic:
            from: result.systemout
        assertions:
          - result.code ShouldEqual 0
          - result.systemout ShouldEqual "00000001"

      - type: http
        method: GET
        url: "{{.target_url}}/api/diagrams/parse?shareUrl={{.encoded_share_prefix}}{{.generate_parse_flow.share_id}}%2C{{.generate_parse_flow.encryption_key}}"
        headers:
          x-vercel-protection-bypass: "{{.bypass_secret}}"
          x-trace-id: "{{.trace_id_parse}}"
        assertions:
          - result.statuscode ShouldEqual 200
          - result.headers.X-Trace-Id ShouldEqual "{{.trace_id_parse}}"
          - result.bodyjson.stats.nodeCount ShouldEqual 2
          - result.bodyjson.stats.edgeCount ShouldEqual 1
          - result.bodyjson.stats.traceId ShouldEqual "{{.trace_id_parse}}"

  - name: modify_flow
    steps:
      - type: http
        method: POST
        url: "{{.target_url}}/api/diagrams/generate"
        headers:
          Content-Type: application/json
          x-vercel-protection-bypass: "{{.bypass_secret}}"
          x-trace-id: "{{.trace_id_modify}}"
        body: |
          {
            "intermediate": {
              "nodes": [
                { "id": "node-1", "label": "Start" },
                { "id": "node-2", "label": "End" }
              ],
              "edges": [
                { "fromId": "node-1", "toId": "node-2", "label": "next" }
              ],
              "graphOptions": { "diagramType": "flowchart" }
            }
          }
        vars:
          share_url:
            from: result.bodyjson.shareLink.url
        assertions:
          - result.statuscode ShouldEqual 200
          - result.headers.X-Trace-Id ShouldEqual "{{.trace_id_modify}}"
          - result.bodyjson.status ShouldEqual "success"

      - type: http
        method: POST
        url: "{{.target_url}}/api/diagrams/modify"
        headers:
          Content-Type: application/json
          x-vercel-protection-bypass: "{{.bypass_secret}}"
          x-trace-id: "{{.trace_id_modify}}"
        body: |
          {
            "shareUrl": "{{.modify_flow.share_url}}",
            "request": "node-1_text text = 'Updated Start' node-1_text originalText = 'Updated Start'",
            "options": { "preferExplicitEdits": true }
          }
        vars:
          modified_share_id:
            from: result.bodyjson.shareLink.shareId
        assertions:
          - result.statuscode ShouldEqual 200
          - result.headers.X-Trace-Id ShouldEqual "{{.trace_id_modify}}"
          - result.bodyjson.status ShouldEqual "success"
          - result.bodyjson.shareLink.url ShouldContainSubstring "https://excalidraw.com/#json="
          - result.bodyjson.stats.traceId ShouldEqual "{{.trace_id_modify}}"

      - type: exec
        script: |
          set -e
          tmpfile="$(mktemp)"
          curl -fsSL --retry 3 --retry-all-errors -o "$tmpfile" "https://json.excalidraw.com/api/v2/{{.modify_flow.modified_share_id}}"
          od -An -t x1 -N 4 "$tmpfile" | tr -d ' \n'
          rm -f "$tmpfile"
        vars:
          v2_magic:
            from: result.systemout
        assertions:
          - result.code ShouldEqual 0
          - result.systemout ShouldEqual "00000001"

  - name: share_flow
    steps:
      - type: http
        method: POST
        url: "{{.target_url}}/api/diagrams/share"
        headers:
          Content-Type: application/json
          x-vercel-protection-bypass: "{{.bypass_secret}}"
          x-trace-id: "{{.trace_id_share}}"
        body: |
          {
            "elements": [
              {
                "id": "node-1",
                "type": "rectangle",
                "x": 0,
                "y": 0,
                "width": 120,
                "height": 60,
                "angle": 0,
                "strokeColor": "#1971c2",
                "backgroundColor": "#a5d8ff",
                "fillStyle": "solid",
                "strokeWidth": 2,
                "strokeStyle": "solid",
                "roughness": 1,
                "opacity": 100,
                "groupIds": [],
                "frameId": null,
                "index": "a0",
                "roundness": { "type": 3 },
                "seed": 101,
                "version": 1,
                "versionNonce": 30101,
                "isDeleted": false,
                "boundElements": null,
                "updated": 1725000000000,
                "link": null,
                "locked": false
              }
            ],
            "appState": {}
          }
        vars:
          share_id:
            from: result.bodyjson.shareId
        assertions:
          - result.statuscode ShouldEqual 200
          - result.headers.X-Trace-Id ShouldEqual "{{.trace_id_share}}"
          - result.bodyjson.url ShouldContainSubstring "https://excalidraw.com/#json="
          - result.bodyjson.shareId ShouldNotBeEmpty

      - type: exec
        script: |
          set -e
          tmpfile="$(mktemp)"
          curl -fsSL --retry 3 --retry-all-errors -o "$tmpfile" "https://json.excalidraw.com/api/v2/{{.share_flow.share_id}}"
          od -An -t x1 -N 4 "$tmpfile" | tr -d ' \n'
          rm -f "$tmpfile"
        vars:
          v2_magic:
            from: result.systemout
        assertions:
          - result.code ShouldEqual 0
          - result.systemout ShouldEqual "00000001"

  - name: parse_v2_share_link_regression
    steps:
      - type: http
        method: GET
        url: "{{.target_url}}/api/diagrams/parse?shareUrl={{.encoded_v2_share_url}}"
        headers:
          x-vercel-protection-bypass: "{{.bypass_secret}}"
        assertions:
          - result.statuscode ShouldEqual 200
          - result.bodyjson.stats.nodeCount ShouldEqual 3
          - result.bodyjson.stats.edgeCount ShouldEqual 0
          - result.bodyjson.stats.elementCount ShouldEqual 6
  - name: error_trace
    steps:
      - type: http
        method: GET
        url: "{{.target_url}}/api/diagrams/parse?shareUrl=https://example.com"
        headers:
          x-vercel-protection-bypass: "{{.bypass_secret}}"
          x-trace-id: "{{.trace_id_error}}"
        assertions:
          - result.statuscode ShouldBeGreaterThan 399
          - result.headers.X-Trace-Id ShouldEqual "{{.trace_id_error}}"
          - result.bodyjson.data.traceId ShouldEqual "{{.trace_id_error}}"
