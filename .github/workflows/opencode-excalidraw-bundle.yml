name: opencode-excalidraw-bundle

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  bundle:
    runs-on: blacksmith-2vcpu-ubuntu-2404
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Tooling
        uses: jdx/mise-action@d6e32c1796099e0f1f3ac741c220a8b7eae9e5dd
        with:
          install: true
          cache: true
          experimental: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build
        run: |
          mise run -C packages/opencode-excalidraw setup
          mise run -C packages/opencode-excalidraw test
          mise run -C packages/opencode-excalidraw build

      - name: Create bundle
        run: |
          mkdir -p bundle
          cp -R packages/opencode-excalidraw/dist bundle/dist
          cp packages/opencode-excalidraw/package.json bundle/package.json
          cp packages/opencode-excalidraw/README.md bundle/README.md
          cp packages/opencode-excalidraw/CHANGELOG.md bundle/CHANGELOG.md
          tar -czf opencode-excalidraw-bundle.tgz -C bundle .

      - name: Upload bundle
        uses: actions/upload-artifact@v4
        with:
          name: opencode-excalidraw-bundle
          if-no-files-found: error
          path: opencode-excalidraw-bundle.tgz
