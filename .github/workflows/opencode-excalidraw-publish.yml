name: opencode-excalidraw-publish

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "npm tag (latest or next)"
        required: true
        type: choice
        options:
          - latest
          - next
  repository_dispatch:
    types: [publish-opencode-excalidraw]

permissions:
  id-token: write
  attestations: write
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Tooling
        uses: jdx/mise-action@d6e32c1796099e0f1f3ac741c220a8b7eae9e5dd
        with:
          install: true
          cache: true
          experimental: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup
        run: mise run -C packages/opencode-excalidraw setup

      - name: Test
        run: mise run -C packages/opencode-excalidraw test

      - id: inputs
        uses: simenandre/setup-inputs@v1

      - name: Publish to npm with OIDC
        run: |
          set -euo pipefail

          TAG="${{ steps.inputs.outputs.tag }}"
          if [ -z "$TAG" ]; then
            TAG="latest"
          fi

          echo "Publishing with tag: ${TAG}"
          mise run -C packages/opencode-excalidraw publish --tag "${TAG}"

      - name: Verify published version
        run: |
          set -euo pipefail

          TAG="${{ steps.inputs.outputs.tag }}"
          if [ -z "$TAG" ]; then
            TAG="latest"
          fi

          NAME="$(node -p 'require("./packages/opencode-excalidraw/package.json").name')"
          VERSION="$(node -p 'require("./packages/opencode-excalidraw/package.json").version')"
          echo "Checking npm dist-tag '$TAG' for ${NAME}@${VERSION}..."

          # npm registry can be eventually consistent right after publish.
          # Give it a short window to make the new version visible.
          for i in $(seq 1 20); do
            if npm view "${NAME}@${VERSION}" version >/dev/null 2>&1; then
              break
            fi

            if [ "$i" -eq 20 ]; then
              echo "[ERROR] npm does not report ${NAME}@${VERSION} after publish"
              exit 1
            fi

            echo "Waiting for npm to show ${NAME}@${VERSION} (${i}/20)..."
            sleep 3
          done

          for i in $(seq 1 20); do
            DIST_VERSION="$(npm view "${NAME}" dist-tags."${TAG}" 2>/dev/null || true)"
            if [ -n "$DIST_VERSION" ] && [ "$DIST_VERSION" = "$VERSION" ]; then
              break
            fi

            if [ "$i" -eq 20 ]; then
              echo "[ERROR] dist-tag '$TAG' points to ${DIST_VERSION:-<empty>} (expected $VERSION)"
              exit 1
            fi

            echo "Waiting for dist-tag '$TAG' to update (${i}/20)..."
            sleep 3
          done

          # Best-effort signals: confirm OIDC publisher + provenance attestation.
          EXPECTED_OIDC_EMAIL="npm-oidc-no-reply@github.com"
          NPM_USER_EMAIL=""
          NPM_USER_NAME=""
          NPM_USER_RAW=""
          for i in $(seq 1 20); do
            VIEW_JSON="$(npm view "${NAME}@${VERSION}" --json 2>/dev/null || true)"

            NPM_USER_RAW="$(
              printf '%s' "$VIEW_JSON" | node -e '
                const fs = require("fs");
                const s = fs.readFileSync(0, "utf8").trim();
                if (!s) process.exit(0);
                try {
                  const j = JSON.parse(s);
                  const u = j._npmUser ?? j.dist?._npmUser ?? null;
                  if (u == null) process.exit(0);
                  if (typeof u === "string") process.stdout.write(u);
                  else if (typeof u === "object" && typeof u.name === "string") process.stdout.write(u.name);
                } catch {}
              '
            )"
            NPM_USER_EMAIL="$(
              printf '%s' "$VIEW_JSON" | node -e '
                const fs = require("fs");
                const s = fs.readFileSync(0, "utf8").trim();
                if (!s) process.exit(0);
                try {
                  const j = JSON.parse(s);
                  const u = j._npmUser ?? j.dist?._npmUser ?? null;
                  if (typeof u === "string") {
                    const m = u.match(/<([^>]+)>/);
                    if (m) process.stdout.write(String(m[1]));
                  } else if (u && typeof u === "object" && u.email) {
                    process.stdout.write(String(u.email));
                  }
                } catch {}
              '
            )"
            NPM_USER_NAME="$(
              printf '%s' "$VIEW_JSON" | node -e '
                const fs = require("fs");
                const s = fs.readFileSync(0, "utf8").trim();
                if (!s) process.exit(0);
                try {
                  const j = JSON.parse(s);
                  const u = j._npmUser ?? j.dist?._npmUser ?? null;
                  if (typeof u === "string") {
                    const m = u.match(/^([^<]+)</);
                    if (m) process.stdout.write(String(m[1]).trim());
                    else process.stdout.write(u);
                  } else if (u && typeof u === "object" && u.name) {
                    process.stdout.write(String(u.name));
                  }
                } catch {}
              '
            )"

            if [ "$NPM_USER_EMAIL" = "$EXPECTED_OIDC_EMAIL" ] || [ "$NPM_USER_NAME" = "$EXPECTED_OIDC_EMAIL" ] || printf '%s' "$NPM_USER_RAW" | grep -q "$EXPECTED_OIDC_EMAIL"; then
              break
            fi

            if [ "$i" -eq 20 ]; then
              echo "[ERROR] expected OIDC publish; npm reports _npmUser.raw='${NPM_USER_RAW:-<empty>}' _npmUser.email='${NPM_USER_EMAIL:-<empty>}' _npmUser.name='${NPM_USER_NAME:-<empty>}'"
              exit 1
            fi

            echo "Waiting for npm _npmUser to show OIDC publisher (${i}/20)..."
            sleep 3
          done

          PREDICATE_TYPE=""
          for i in $(seq 1 20); do
            VIEW_JSON="$(npm view "${NAME}@${VERSION}" --json 2>/dev/null || true)"
            PREDICATE_TYPE="$(
              printf '%s' "$VIEW_JSON" | node -e '
                const fs = require("fs");
                const s = fs.readFileSync(0, "utf8").trim();
                if (!s) process.exit(0);
                try {
                  const j = JSON.parse(s);
                  const p = j.dist?.attestations?.provenance?.predicateType ?? "";
                  if (p) process.stdout.write(String(p));
                } catch {}
              '
            )"

            if [ "$PREDICATE_TYPE" = "https://slsa.dev/provenance/v1" ]; then
              break
            fi

            if [ "$i" -eq 20 ]; then
              echo "[ERROR] missing/incorrect provenance attestation predicateType: '${PREDICATE_TYPE:-<empty>}'"
              exit 1
            fi

            echo "Waiting for provenance attestation predicateType (${i}/20)..."
            sleep 3
          done

          echo "✓ npm publish verification passed"

      - name: Create linked artifact metadata record
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          NAME="$(node -p 'require("./packages/opencode-excalidraw/package.json").name')"
          VERSION="$(node -p 'require("./packages/opencode-excalidraw/package.json").version')"
          OWNER="${GITHUB_REPOSITORY_OWNER}"
          REPO_NAME="${GITHUB_REPOSITORY#*/}"

          VIEW_JSON="$(npm view "${NAME}@${VERSION}" --json)"
          TARBALL_URL="$({
            printf '%s' "$VIEW_JSON" | node -e '
              const fs = require("fs");
              const s = fs.readFileSync(0, "utf8").trim();
              if (!s) process.exit(0);
              const j = JSON.parse(s);
              process.stdout.write(String(j.dist?.tarball ?? ""));
            '
          })"

          if [ -z "$TARBALL_URL" ]; then
            echo "[ERROR] missing npm tarball URL for ${NAME}@${VERSION}"
            exit 1
          fi

          TMP_TGZ="$(mktemp -t opencode-excalidraw-XXXXXX.tgz)"
          trap 'rm -f "$TMP_TGZ"' EXIT
          curl -fsSL "$TARBALL_URL" -o "$TMP_TGZ"
          SHA256="$(shasum -a 256 "$TMP_TGZ" | awk '{print $1}')"
          DIGEST="sha256:${SHA256}"

          echo "Creating storage record for digest ${DIGEST}"
          gh api -X POST "orgs/${OWNER}/artifacts/metadata/storage-record" \
            -f name="${NAME}" \
            -f version="${VERSION}" \
            -f digest="${DIGEST}" \
            -f artifact_url="${TARBALL_URL}" \
            -f registry_url="https://registry.npmjs.org" \
            -f repository="${NAME}" \
            -f github_repository="${REPO_NAME}" \
            > /tmp/opencode-excalidraw-storage-record.json

          RECORD_ID="$({
            node -e '
              const fs = require("fs");
              const j = JSON.parse(fs.readFileSync("/tmp/opencode-excalidraw-storage-record.json", "utf8"));
              const id = j.storage_records?.[0]?.id;
              if (id !== undefined && id !== null) process.stdout.write(String(id));
            '
          })"

          RECORD_COUNT="0"
          for i in $(seq 1 20); do
            if gh api "orgs/${OWNER}/artifacts/${DIGEST}/metadata/storage-records" >/tmp/opencode-excalidraw-storage-records.json 2>/tmp/opencode-excalidraw-storage-records.err; then
              RECORD_COUNT="$({
                node -e '
                  const fs = require("fs");
                  const j = JSON.parse(fs.readFileSync("/tmp/opencode-excalidraw-storage-records.json", "utf8"));
                  const count = Number(j.total_count ?? 0);
                  process.stdout.write(String(count));
                '
              })"
              if [ "${RECORD_COUNT}" -ge 1 ]; then
                break
              fi
            fi

            if [ "$i" -eq 20 ]; then
              echo "[ERROR] linked artifact storage record not found for ${DIGEST}"
              if [ -s /tmp/opencode-excalidraw-storage-records.err ]; then
                cat /tmp/opencode-excalidraw-storage-records.err
              fi
              exit 1
            fi

            echo "Waiting for linked artifact storage record indexing (${i}/20)..."
            sleep 3
          done

          {
            echo "## OpenCode Excalidraw Artifact Metadata"
            echo "- Package: \\`${NAME}@${VERSION}\\`"
            echo "- Digest: \\`${DIGEST}\\`"
            echo "- Storage record id: \\`${RECORD_ID:-unknown}\\`"
            echo "- Tarball: ${TARBALL_URL}"
          } >> "$GITHUB_STEP_SUMMARY"

          echo "OPENCODE_TARBALL_URL=${TARBALL_URL}" >> "$GITHUB_ENV"
          echo "OPENCODE_STORAGE_DIGEST=${DIGEST}" >> "$GITHUB_ENV"

          echo "✓ linked artifact storage record created"

      - name: Download tarball for GitHub attestation
        run: |
          set -euo pipefail

          if [ -z "${OPENCODE_TARBALL_URL:-}" ]; then
            echo "[ERROR] missing OPENCODE_TARBALL_URL"
            exit 1
          fi

          curl -fsSL "${OPENCODE_TARBALL_URL}" -o /tmp/opencode-excalidraw.tgz

      - name: Create GitHub provenance attestation for tarball
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: /tmp/opencode-excalidraw.tgz
