name: opencode-excalidraw-release

on:
  push:
    branches:
      - main
    paths:
      - "packages/opencode-excalidraw/**"
      - ".github/workflows/opencode-excalidraw-*.yml"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}

permissions:
  contents: write
  pull-requests: write

jobs:
  process:
    runs-on: ubuntu-latest
    outputs:
      releases_created: ${{ steps.release_please.outputs.releases_created }}
      prs_created: ${{ (steps.release_please.outputs.prs_created == 'true' || steps.force_release_pr.outputs.prs_created == 'true') && 'true' || 'false' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect plugin package changes in this push
        id: changes
        run: |
          set -euo pipefail
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          if [ -z "$BEFORE" ] || [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            echo "plugin_changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if git diff --name-only "$BEFORE" "$AFTER" | grep -q '^packages/opencode-excalidraw/'; then
            echo "plugin_changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "plugin_changed=false" >> "$GITHUB_OUTPUT"
          fi

      - uses: googleapis/release-please-action@v4
        id: release_please
        with:
          token: ${{ secrets.RELEASE_PLEASE_TOKEN || github.token }}
          config-file: packages/opencode-excalidraw/release-please-config.json
          manifest-file: packages/opencode-excalidraw/.release-please-manifest.json
          skip-github-pull-request: false

      - name: Force release PR when plugin changed but release-please skipped
        id: force_release_pr
        if: steps.changes.outputs.plugin_changed == 'true' && steps.release_please.outputs.releases_created != 'true' && steps.release_please.outputs.prs_created != 'true'
        env:
          GH_TOKEN: ${{ secrets.RELEASE_PLEASE_TOKEN || github.token }}
        run: |
          set -euo pipefail

          CURRENT_VERSION="$(node -p 'require("./packages/opencode-excalidraw/package.json").version')"
          NEXT_VERSION="$(node -e 'const v=process.argv[1].split(".").map(Number); if (v.length!==3 || v.some(Number.isNaN)) { process.exit(1); } console.log(`${v[0]}.${v[1]}.${v[2] + 1}`);' "$CURRENT_VERSION")"

          echo "release-please reported no PR/release for plugin changes; forcing release PR as $NEXT_VERSION"

          npx --yes release-please release-pr \
            --token "$GH_TOKEN" \
            --repo-url "${{ github.repository }}" \
            --target-branch main \
            --config-file packages/opencode-excalidraw/release-please-config.json \
            --manifest-file packages/opencode-excalidraw/.release-please-manifest.json \
            --release-as "$NEXT_VERSION"

          echo "prs_created=true" >> "$GITHUB_OUTPUT"

  dispatch-publish:
    needs: process
    runs-on: ubuntu-latest
    if: needs.process.outputs.releases_created == 'true' || needs.process.outputs.prs_created == 'true'
    steps:
      - name: Dispatch publish for releases
        if: needs.process.outputs.releases_created == 'true'
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: publish-opencode-excalidraw
          client-payload: '{"tag":"latest"}'

      - name: Dispatch publish for prerelease
        if: needs.process.outputs.prs_created == 'true'
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: publish-opencode-excalidraw
          client-payload: '{"tag":"next"}'
